events {}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # Увеличиваем размер хеша для имен серверов (исправляет предупреждения)
    server_names_hash_bucket_size 128;
    server_names_hash_max_size 512;
    proxy_headers_hash_max_size 1024;
    proxy_headers_hash_bucket_size 128;

    upstream backend {
        server api-service:3000;  # Используем новое фиксированное имя контейнера
    }

    # Обновляем настройки real_ip
    real_ip_recursive on;  # Включаем рекурсивный поиск реального IP
    real_ip_header X-Forwarded-For;

    # Формат логов
    log_format detailed '$remote_addr - $remote_user [$time_local] '
                        '"$request" $status $body_bytes_sent '
                        '"$http_referer" "$http_user_agent" '
                        'http_x_forwarded_for="$http_x_forwarded_for" '
                        'realip_remote_addr="$realip_remote_addr" '
                        'proxy_add_x_forwarded_for="$proxy_add_x_forwarded_for" '
                        'http_x_client_ip="$http_x_client_ip" '
                        'http_x_real_ip="$http_x_real_ip" '
                        'custom_client_info="$custom_client_info" '
                        'custom_action_info="$custom_action_info" '
                        'user_agent="$user_agent" '
                        'http_user_agent="$http_user_agent" '
                        'processed_by="$http_x_processed_by" '
                        'request_source="$http_x_request_source" '
                        'request_time="$request_time" '
                        'upstream_response_time="$upstream_response_time" '
                        'scheme="$scheme" '
                        'server_protocol="$server_protocol"';
    
    server {
        listen 80;
        listen [::]:80;
        # Определяем переменные здесь

        server_name localhost ${DOMAINS};
        root /var/www/certbot;

        access_log /var/log/nginx/access.log detailed;

        # Location для метрик NGINX
        location /nginx_status {
            stub_status on;
            allow 0.0.0.0/0;  # Разрешаем доступ от всех IP-адресов (проверьте безопасность)
            deny all;         # По умолчанию запрещаем доступ
        }

        # Конфигурация для Let's Encrypt
        location ^~ /.well-known/acme-challenge/ {
            allow all;
            autoindex on;  # Добавим для отладки
            default_type "text/plain";
            add_header Content-Type "text/plain" always;
            add_header X-Debug-Path "$document_root$uri" always;
            add_header X-Real-Path $request_filename always;
        }

        # Проксирование запросов к API
        location / {
            set $original_client_ip $http_x_forwarded_for;
            if ($http_x_forwarded_for ~ "^(.+),") {
                set $original_client_ip $1;
            }

            # Обновляем заголовки
            proxy_set_header X-Client-IP $original_client_ip;
            proxy_set_header X-Real-IP $original_client_ip;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            # WebSocket specific settings
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_cache_bypass $http_upgrade;

            # Базовые заголовки (всегда)
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Request-ID $request_id;

            # Правильные заголовки времени
            proxy_set_header X-Request-Time $request_time;        # Время обработки запроса
            proxy_set_header X-Response-Time $upstream_response_time;  # Время ответа от upstream

            proxy_pass http://backend;

            # Определяем переменные для заголовков
            set $client_ip $realip_remote_addr;
            set $request_source "api";
            set $processed_by "api-nginx";
            set $custom_action_info "$remote_addr | $http_user_agent";
            set $custom_client_info "";
            set $real_ip $realip_remote_addr;
            set $client_info "";
            set $x_forwarded_for $proxy_add_x_forwarded_for;
            set $user_agent $http_user_agent;

            proxy_set_header X-Processed-By $processed_by;
            proxy_set_header X-Client-IP $client_ip;
            proxy_set_header X-Real-IP $real_ip;
            proxy_set_header X-Custom-Action-Info $custom_action_info;
            proxy_set_header X-Custom-Client-Info $custom_client_info;
            proxy_set_header X-Request-Source $request_source;
            proxy_set_header X-Client-Info $client_info;
            proxy_set_header X-Forwarded-For $x_forwarded_for;
            proxy_set_header X-User-Agent $user_agent;

            # Настройки буферизации
            proxy_buffering off;
            proxy_request_buffering off;

            # Увеличенные таймауты для WebSocket
            proxy_connect_timeout 60s;
            proxy_send_timeout 300s;
            proxy_read_timeout 300s;
        }
    }
}
